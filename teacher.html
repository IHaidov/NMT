<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Вхід для вчителя — НМТ</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .auth-tabs { display: flex; gap: 0; margin-bottom: 16px; }
    .auth-tab { padding: 10px 20px; border: 1px solid #d0d5dc; background: #f5f6f8; cursor: pointer; border-radius: 8px 8px 0 0; }
    .auth-tab.active { background: #fff; border-bottom-color: #fff; margin-bottom: -1px; }
    .auth-panel { display: none; padding: 20px; border: 1px solid #d0d5dc; border-radius: 0 8px 8px 8px; background: #fff; }
    .auth-panel.active { display: block; }
    .teacher-dash { max-width: none; width: 100%; }
    .app-container { max-width: none; }
    .teacher-dash h2 { margin-top: 0; }
    .class-list { list-style: none; padding: 0; margin: 0; }
    .class-list li { margin-bottom: 12px; }
    .class-list a { display: block; padding: 14px 18px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; color: #1a1f2e; text-decoration: none; font-weight: 500; }
    .class-list a:hover { background: #e8eef7; border-color: #2563eb; }
    .class-list .meta { font-size: 0.85rem; color: #5f6b7a; margin-top: 4px; }
    .btn-create { margin-bottom: 20px; }
    .teacher-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; }
    .teacher-user { font-size: 0.9rem; color: #5f6b7a; }
    .logout-btn { font-size: 0.9rem; }
    .class-otp { font-size: 0.9rem; margin-top: 6px; }
    .class-otp code { font-weight: 700; letter-spacing: 0.15em; color: #0369a1; background: #f0f9ff; padding: 2px 8px; border-radius: 4px; }
    .class-otp .otp-expiry { font-size: 0.8rem; color: #5f6b7a; margin-top: 2px; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-left">
        <a href="./index.html" class="header-logo" title="На початковий екран">НМТ</a>
        <div class="header-text">
          <h1>Кабінет вчителя</h1>
          <p class="header-subtitle">Підготовчі завдання з Математики для національного мультипредметного тесту</p>
        </div>
      </div>
      <div class="header-right header-nav" id="teacher-header-actions"></div>
    </header>

    <main id="auth-screen">
      <section class="card start-screen">
        <h2>Увійти як вчитель</h2>
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" data-tab="login">Увійти</button>
          <button type="button" class="auth-tab" data-tab="register">Зареєструватись</button>
        </div>
        <div id="login-panel" class="auth-panel active">
          <label class="field-label">Електронна пошта</label>
          <input type="email" id="login-email" class="text-input" placeholder="your@email.ua" />
          <label class="field-label">Пароль</label>
          <input type="password" id="login-password" class="text-input" />
          <p id="login-error" class="input-error"></p>
          <div class="start-actions"><button type="button" id="btn-login" class="btn btn-primary">Увійти</button></div>
        </div>
        <div id="register-panel" class="auth-panel">
          <p class="muted">Реєстрація вчителів відбувається лише через адміністратора. Щоб отримати обліковий запис, напишіть на пошту:</p>
          <p style="margin:12px 0;"><a href="mailto:vanya.haidov@gmail.com">vanya.haidov@gmail.com</a></p>
          <p class="muted">Адміністратор надасть вам пароль, ПІБ, школу та місто для входу.</p>
        </div>
      </section>
    </main>

    <main id="dashboard-screen" class="hidden">
      <section class="card teacher-dash">
        <div class="teacher-header">
          <h2>Мої класи</h2>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;" id="teacher-dash-actions">
            <span class="teacher-user" id="teacher-name"></span>
          </div>
        </div>
        <p class="muted" style="margin:0 0 16px 0;">У кожного класу свій код доступу (OTP). Учні вводять код класу на головній сторінці тесту — після введення пошти вони автоматично приписуються до цього класу.</p>
        <button type="button" id="btn-create-class" class="btn btn-primary btn-create">Створити клас</button>
        <ul class="class-list" id="class-list"></ul>
      </section>
    </main>
  </div>

  <footer class="page-footer">
    <p>Підготувала — Гайдова Віра Вікторівна · 2026</p>
  </footer>

  <script>
    (function () {
      const authScreen = document.getElementById("auth-screen");
      const dashboardScreen = document.getElementById("dashboard-screen");
      const classList = document.getElementById("class-list");
      const teacherNameEl = document.getElementById("teacher-name");

      function showAuth() {
        authScreen.classList.remove("hidden");
        dashboardScreen.classList.add("hidden");
        document.getElementById("teacher-header-actions").innerHTML = "";
      }
      function showDashboard() {
        authScreen.classList.add("hidden");
        dashboardScreen.classList.remove("hidden");
      }

      document.querySelectorAll(".auth-tab").forEach(function (tab) {
        tab.addEventListener("click", function () {
          document.querySelectorAll(".auth-tab").forEach(function (t) { t.classList.remove("active"); });
          document.querySelectorAll(".auth-panel").forEach(function (p) { p.classList.remove("active"); });
          tab.classList.add("active");
          var panel = document.getElementById(tab.dataset.tab + "-panel");
          if (panel) panel.classList.add("active");
        });
      });

      function api(path, opts) {
        return fetch(path, { credentials: "include", ...opts }).then(function (r) {
          if (r.status === 401) { showAuth(); return Promise.reject(new Error("Не авторизовано")); }
          return r.json().then(function (data) { if (!r.ok) throw new Error(data.error || "Помилка"); return data; });
        });
      }

      document.getElementById("btn-login").addEventListener("click", function () {
        var email = document.getElementById("login-email").value.trim();
        var password = document.getElementById("login-password").value;
        document.getElementById("login-error").textContent = "";
        if (!email || !password) { document.getElementById("login-error").textContent = "Введіть пошту та пароль"; return; }
        api("/api/teachers/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: email, password: password }) })
          .then(function (data) {
            if (data.teacher && data.teacher.isAdmin) { window.location.href = "admin.html"; return; }
            loadDashboard();
          })
          .catch(function (e) { document.getElementById("login-error").textContent = e.message || "Помилка входу"; });
      });

      function buildTeacherHeader(teacher) {
        var actions = document.getElementById("teacher-header-actions");
        var parts = [
          '<a href="./teacher-questions.html" class="info-link">База питань</a>',
          '<a href="./teacher-editor.html" class="info-link">Редактор завдань</a>'
        ];
        if (teacher.isImpersonated) {
          parts.push('<span class="teacher-user" style="font-size:0.85rem;color:#64748b;">Від імені: ' + escapeHtml(teacher.name) + '</span>');
          parts.push('<a href="#" id="btn-stop-impersonate" class="info-link">Повернутись до адміна</a>');
        }
        parts.push('<span class="teacher-user" id="teacher-name">' + escapeHtml(teacher.name) + ' (' + escapeHtml(teacher.email) + ')</span>');
        parts.push('<button type="button" id="btn-logout" class="btn btn-secondary logout-btn">Вийти</button>');
        actions.innerHTML = parts.join("");
        document.getElementById("btn-logout").addEventListener("click", function () {
          fetch("/api/teachers/logout", { method: "POST", credentials: "include" }).then(function () { showAuth(); });
        });
        var stopBtn = document.getElementById("btn-stop-impersonate");
        if (stopBtn) {
          stopBtn.addEventListener("click", function (e) {
            e.preventDefault();
            fetch("/api/admin/stop-impersonate", { method: "POST", credentials: "include" })
              .then(function () { window.location.href = "admin.html"; });
          });
        }
      }

      function loadDashboard() {
        api("/api/teachers/me").then(function (data) {
          if (data.teacher && data.teacher.isAdmin) { window.location.href = "admin.html"; return Promise.reject(); }
          teacherNameEl.textContent = data.teacher.name + " (" + data.teacher.email + ")";
          buildTeacherHeader(data.teacher);
          return api("/api/classes");
        }).then(function (data) {
          classList.innerHTML = "";
          data.classes.forEach(function (c) {
            var li = document.createElement("li");
            var exp = c.otp_expires_at ? new Date(c.otp_expires_at) : null;
            var expiryText = exp ? (exp > new Date() ? "Дійсний до: " + exp.toLocaleString("uk-UA") : "Прострочено") : "";
            li.innerHTML = '<a href="./class.html?id=' + c.id + '">' + escapeHtml(c.name) + '</a><div class="meta">Створено: ' + (c.created_at || "").slice(0, 10) + '</div><div class="class-otp"><span>Код для учнів: </span><code>' + escapeHtml(c.otp_code || "—") + '</code><div class="otp-expiry">' + expiryText + '</div></div>';
            classList.appendChild(li);
          });
          showDashboard();
        }).catch(function () {});
      }

      document.getElementById("btn-create-class").addEventListener("click", function () {
        var name = prompt("Назва класу:");
        if (!name || !name.trim()) return;
        api("/api/classes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name: name.trim() }) })
          .then(function () { loadDashboard(); })
          .catch(function (e) { alert(e.message || "Помилка"); });
      });

      function escapeHtml(s) {
        if (s == null) return "";
        var d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }

      api("/api/teachers/me").then(function () { loadDashboard(); }).catch(function () {});
    })();
  </script>
</body>
</html>
