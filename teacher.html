<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Вхід для вчителя — НМТ</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .auth-tabs { display: flex; gap: 0; margin-bottom: 16px; }
    .auth-tab { padding: 10px 20px; border: 1px solid #d0d5dc; background: #f5f6f8; cursor: pointer; border-radius: 8px 8px 0 0; }
    .auth-tab.active { background: #fff; border-bottom-color: #fff; margin-bottom: -1px; }
    .auth-panel { display: none; padding: 20px; border: 1px solid #d0d5dc; border-radius: 0 8px 8px 8px; background: #fff; }
    .auth-panel.active { display: block; }
    .teacher-dash { max-width: 800px; }
    .teacher-dash h2 { margin-top: 0; }
    .class-list { list-style: none; padding: 0; margin: 0; }
    .class-list li { margin-bottom: 12px; }
    .class-list a { display: block; padding: 14px 18px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; color: #1a1f2e; text-decoration: none; font-weight: 500; }
    .class-list a:hover { background: #e8eef7; border-color: #2563eb; }
    .class-list .meta { font-size: 0.85rem; color: #5f6b7a; margin-top: 4px; }
    .btn-create { margin-bottom: 20px; }
    .teacher-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; }
    .teacher-user { font-size: 0.9rem; color: #5f6b7a; }
    .logout-btn { font-size: 0.9rem; }
    .otp-box { background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
    .otp-box h3 { margin: 0 0 8px 0; font-size: 1rem; }
    .otp-code { font-size: 1.5rem; font-weight: 700; letter-spacing: 0.2em; font-family: monospace; color: #0369a1; }
    .otp-expiry { font-size: 0.85rem; color: #5f6b7a; margin-top: 8px; }
    .otp-box .btn { margin-top: 12px; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-left">
        <div class="header-text">
          <h1>Кабінет вчителя</h1>
          <p class="header-subtitle">Підготовчі завдання з Математики для національного мультипредметного тесту</p>
        </div>
      </div>
      <div class="header-right">
        <a href="./index.html" class="info-link"><span class="info-icon">←</span><span class="info-text">На головну</span></a>
      </div>
    </header>

    <main id="auth-screen">
      <section class="card start-screen">
        <h2>Увійти як вчитель</h2>
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" data-tab="login">Увійти</button>
          <button type="button" class="auth-tab" data-tab="register">Зареєструватись</button>
        </div>
        <div id="login-panel" class="auth-panel active">
          <label class="field-label">Електронна пошта</label>
          <input type="email" id="login-email" class="text-input" placeholder="your@email.ua" />
          <label class="field-label">Пароль</label>
          <input type="password" id="login-password" class="text-input" />
          <p id="login-error" class="input-error"></p>
          <div class="start-actions"><button type="button" id="btn-login" class="btn btn-primary">Увійти</button></div>
        </div>
        <div id="register-panel" class="auth-panel">
          <p class="muted">Реєстрація вчителів відбувається лише через адміністратора. Щоб отримати обліковий запис, напишіть на пошту:</p>
          <p style="margin:12px 0;"><a href="mailto:vanya.haidov@gmail.com">vanya.haidov@gmail.com</a></p>
          <p class="muted">Адміністратор надасть вам пароль, ПІБ, школу та місто для входу.</p>
        </div>
      </section>
    </main>

    <main id="dashboard-screen" class="hidden">
      <section class="card teacher-dash">
        <div class="teacher-header">
          <h2>Мої класи</h2>
          <div style="display:flex;align-items:center;gap:12px;">
            <span class="teacher-user" id="teacher-name"></span>
            <button type="button" id="btn-logout" class="btn btn-secondary logout-btn">Вийти</button>
          </div>
        </div>
        <div id="otp-box" class="otp-box">
          <h3>Код доступу для учнів (OTP)</h3>
          <p class="muted" style="margin:0 0 8px 0;">Учні вводять цей код на головній сторінці тесту, щоб отримати доступ.</p>
          <div id="otp-code-display" class="otp-code">—</div>
          <div id="otp-expiry-display" class="otp-expiry"></div>
          <button type="button" id="btn-regenerate-otp" class="btn btn-secondary">Перегенерувати код</button>
        </div>
        <button type="button" id="btn-create-class" class="btn btn-primary btn-create">Створити клас</button>
        <ul class="class-list" id="class-list"></ul>
      </section>
    </main>
  </div>

  <footer class="page-footer">
    <p>Підготувала — Гайдова Віра Вікторівна · 2026</p>
  </footer>

  <script>
    (function () {
      const authScreen = document.getElementById("auth-screen");
      const dashboardScreen = document.getElementById("dashboard-screen");
      const classList = document.getElementById("class-list");
      const teacherNameEl = document.getElementById("teacher-name");

      function showAuth() {
        authScreen.classList.remove("hidden");
        dashboardScreen.classList.add("hidden");
      }
      function showDashboard() {
        authScreen.classList.add("hidden");
        dashboardScreen.classList.remove("hidden");
      }

      document.querySelectorAll(".auth-tab").forEach(function (tab) {
        tab.addEventListener("click", function () {
          document.querySelectorAll(".auth-tab").forEach(function (t) { t.classList.remove("active"); });
          document.querySelectorAll(".auth-panel").forEach(function (p) { p.classList.remove("active"); });
          tab.classList.add("active");
          var panel = document.getElementById(tab.dataset.tab + "-panel");
          if (panel) panel.classList.add("active");
        });
      });

      function api(path, opts) {
        return fetch(path, { credentials: "include", ...opts }).then(function (r) {
          if (r.status === 401) { showAuth(); return Promise.reject(new Error("Не авторизовано")); }
          return r.json().then(function (data) { if (!r.ok) throw new Error(data.error || "Помилка"); return data; });
        });
      }

      document.getElementById("btn-login").addEventListener("click", function () {
        var email = document.getElementById("login-email").value.trim();
        var password = document.getElementById("login-password").value;
        document.getElementById("login-error").textContent = "";
        if (!email || !password) { document.getElementById("login-error").textContent = "Введіть пошту та пароль"; return; }
        api("/api/teachers/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: email, password: password }) })
          .then(function (data) {
            if (data.teacher && data.teacher.isAdmin) { window.location.href = "admin.html"; return; }
            loadDashboard();
          })
          .catch(function (e) { document.getElementById("login-error").textContent = e.message || "Помилка входу"; });
      });

      document.getElementById("btn-logout").addEventListener("click", function () {
        fetch("/api/teachers/logout", { method: "POST", credentials: "include" }).then(function () { showAuth(); });
      });

      function loadOtp() {
        api("/api/teachers/otp").then(function (data) {
          var codeEl = document.getElementById("otp-code-display");
          var expiryEl = document.getElementById("otp-expiry-display");
          if (codeEl) codeEl.textContent = data.code || "—";
          if (expiryEl) {
            var exp = data.expires_at ? new Date(data.expires_at) : null;
            if (exp) {
              var now = new Date();
              if (exp <= now) expiryEl.textContent = "Код прострочено. Натисніть «Перегенерувати».";
              else expiryEl.textContent = "Дійсний до: " + exp.toLocaleString("uk-UA");
            } else expiryEl.textContent = "";
          }
        }).catch(function () {
          var codeEl = document.getElementById("otp-code-display");
          if (codeEl) codeEl.textContent = "—";
        });
      }
      function loadDashboard() {
        api("/api/teachers/me").then(function (data) {
          if (data.teacher && data.teacher.isAdmin) { window.location.href = "admin.html"; return Promise.reject(); }
          teacherNameEl.textContent = data.teacher.name + " (" + data.teacher.email + ")";
          loadOtp();
          return api("/api/classes");
        }).then(function (data) {
          classList.innerHTML = "";
          data.classes.forEach(function (c) {
            var li = document.createElement("li");
            li.innerHTML = '<a href="./class.html?id=' + c.id + '">' + escapeHtml(c.name) + '</a><div class="meta">Створено: ' + (c.created_at || "").slice(0, 10) + '</div>';
            classList.appendChild(li);
          });
          showDashboard();
        }).catch(function () {});
      }
      document.getElementById("btn-regenerate-otp").addEventListener("click", function () {
        var btn = this;
        btn.disabled = true;
        api("/api/teachers/otp/regenerate", { method: "POST" }).then(function (data) {
          loadOtp();
        }).catch(function (e) { alert(e.message); }).finally(function () { btn.disabled = false; });
      });

      document.getElementById("btn-create-class").addEventListener("click", function () {
        var name = prompt("Назва класу:");
        if (!name || !name.trim()) return;
        api("/api/classes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name: name.trim() }) })
          .then(function () { loadDashboard(); })
          .catch(function (e) { alert(e.message || "Помилка"); });
      });

      function escapeHtml(s) {
        if (s == null) return "";
        var d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }

      api("/api/teachers/me").then(function () { loadDashboard(); }).catch(function () {});
    })();
  </script>
</body>
</html>
